#!/bin/bash
#############################################
# COMPLETE BATCH NUMBER SYSTEM INSTALLER
# All-in-One: Database + Backend + Frontend
# CT 101 Debian 12 (192.168.1.15)
# RAM: 8GB | SSD: 32GB
#############################################

set -e
trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
trap 'echo "\"${last_command}\" command failed with exit code $?."' EXIT

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
PROJECT_DIR="/opt/batch-number-system"
DB_NAME="batch_number_db"
DB_USER="batch_admin"
DB_PASSWORD="Batch@2025#Secure"
API_PORT=8000
SERVER_IP="192.168.1.15"

print_banner() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                â•‘
â•‘         ðŸ­  BATCH NUMBER SYSTEM - COMPLETE INSTALLER  ðŸ­       â•‘
â•‘                                                                â•‘
â•‘                     Produksi1 Bolang                           â•‘
â•‘                    CT 101 - 192.168.1.15                       â•‘
â•‘                                                                â•‘
â•‘  Components:                                                   â•‘
â•‘  âœ“ PostgreSQL 16                                               â•‘
â•‘  âœ“ FastAPI Backend                                             â•‘
â•‘  âœ“ React Frontend                                              â•‘
â•‘  âœ“ MQTT Broker                                                 â•‘
â•‘  âœ“ Nginx Proxy                                                 â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
}

print_success() { echo -e "${GREEN}âœ“ $1${NC}"; }
print_error() { echo -e "${RED}âœ— $1${NC}"; }
print_info() { echo -e "${YELLOW}â†’ $1${NC}"; }
print_step() { echo -e "${MAGENTA}â”â”â” $1 â”â”â”${NC}"; }

spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

check_root() {
    if [ "$EUID" -ne 0 ]; then 
        print_error "Please run as root: sudo bash $0"
        exit 1
    fi
}

print_banner
check_root

echo ""
echo "This installer will setup a complete Batch Number System"
echo "Estimated time: 20-25 minutes"
echo ""
read -p "Press ENTER to continue or Ctrl+C to cancel..."
echo ""

START_TIME=$(date +%s)

#############################################
# PHASE 1: SYSTEM PREPARATION
#############################################
print_step "PHASE 1: SYSTEM PREPARATION"

print_info "Updating system..."
apt update -qq >/dev/null 2>&1 &
spinner $!
apt upgrade -y -qq >/dev/null 2>&1 &
spinner $!
print_success "System updated"

print_info "Installing essential packages..."
apt install -y -qq curl wget git vim nano htop net-tools ca-certificates \
    gnupg lsb-release software-properties-common build-essential \
    unzip zip >/dev/null 2>&1 &
spinner $!
print_success "Essential packages installed"

print_info "Installing Python 3.11..."
apt install -y -qq python3 python3-pip python3-venv python3-dev >/dev/null 2>&1 &
spinner $!
PYTHON_VERSION=$(python3 --version)
print_success "Python installed: $PYTHON_VERSION"

print_info "Installing PostgreSQL 16..."
if ! command -v psql &> /dev/null; then
    apt install -y -qq postgresql-common >/dev/null 2>&1
    /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y >/dev/null 2>&1
    apt install -y -qq postgresql-16 postgresql-contrib-16 libpq-dev >/dev/null 2>&1 &
    spinner $!
fi
systemctl enable postgresql >/dev/null 2>&1
systemctl start postgresql
PG_VERSION=$(psql --version | awk '{print $3}')
print_success "PostgreSQL installed: $PG_VERSION"

print_info "Installing Redis..."
apt install -y -qq redis-server >/dev/null 2>&1 &
spinner $!
systemctl enable redis-server >/dev/null 2>&1
systemctl start redis-server
print_success "Redis installed"

print_info "Installing Mosquitto MQTT..."
apt install -y -qq mosquitto mosquitto-clients >/dev/null 2>&1 &
spinner $!
systemctl enable mosquitto >/dev/null 2>&1
systemctl start mosquitto
print_success "Mosquitto MQTT installed"

print_info "Installing Node.js 20 LTS..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - >/dev/null 2>&1
    apt install -y -qq nodejs >/dev/null 2>&1 &
    spinner $!
fi
NODE_VERSION=$(node --version)
print_success "Node.js installed: $NODE_VERSION"

print_info "Installing Nginx..."
apt install -y -qq nginx >/dev/null 2>&1 &
spinner $!
systemctl enable nginx >/dev/null 2>&1
systemctl start nginx
print_success "Nginx installed"

print_info "Creating project structure..."
mkdir -p $PROJECT_DIR/{backend,frontend,config,logs,backups,scripts}
chmod -R 755 $PROJECT_DIR
print_success "Project directory created: $PROJECT_DIR"

echo ""
print_success "âœ“ PHASE 1 COMPLETED"
sleep 2

#############################################
# PHASE 2: DATABASE SETUP
#############################################
print_step "PHASE 2: DATABASE SETUP"

print_info "Creating PostgreSQL database and user..."
sudo -u postgres psql >/dev/null 2>&1 <<EOF
DROP DATABASE IF EXISTS $DB_NAME;
DROP USER IF EXISTS $DB_USER;
CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';
CREATE DATABASE $DB_NAME OWNER $DB_USER;
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
\c $DB_NAME
GRANT ALL ON SCHEMA public TO $DB_USER;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $DB_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $DB_USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $DB_USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $DB_USER;
EOF
print_success "Database created: $DB_NAME"

print_info "Creating database schema..."
cat > /tmp/schema.sql <<'EOSQL'
-- Master Product Table
CREATE TABLE IF NOT EXISTS master_product (
    id SERIAL PRIMARY KEY,
    no INTEGER GENERATED ALWAYS AS IDENTITY,
    nama_product VARCHAR(200) NOT NULL,
    ukuran_roll VARCHAR(100) NOT NULL,
    jumlah_roll_terproduksi INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT unique_product_size UNIQUE (nama_product, ukuran_roll)
);

CREATE INDEX idx_master_product_name ON master_product(nama_product);
CREATE INDEX idx_master_product_size ON master_product(ukuran_roll);

-- Rencana Produksi Table
CREATE TABLE IF NOT EXISTS rencana_produksi (
    id SERIAL PRIMARY KEY,
    no INTEGER GENERATED ALWAYS AS IDENTITY,
    production_plan VARCHAR(100),
    work_order VARCHAR(100),
    permintaan_pp DECIMAL(10,2),
    nama_product VARCHAR(200) NOT NULL,
    ukuran_roll VARCHAR(100) NOT NULL,
    no_lot_product VARCHAR(50) NOT NULL,
    no_urut_roll VARCHAR(10) UNIQUE NOT NULL,
    minta_no_roll BOOLEAN DEFAULT FALSE,
    waktu_input TIMESTAMP NOT NULL DEFAULT NOW(),
    code128_lot_number TEXT NOT NULL,
    status_memproduksi VARCHAR(20) DEFAULT 'pending',
    nama_admin VARCHAR(100) NOT NULL,
    nama_operator VARCHAR(100) NOT NULL,
    waktu_menimbang TIMESTAMP,
    berat_product DECIMAL(10,3),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_rencana_product ON rencana_produksi(nama_product);
CREATE INDEX idx_rencana_status ON rencana_produksi(status_memproduksi);
CREATE INDEX idx_rencana_no_urut ON rencana_produksi(no_urut_roll);
CREATE INDEX idx_rencana_waktu ON rencana_produksi(waktu_input DESC);

-- Print Log Table
CREATE TABLE IF NOT EXISTS print_log (
    id SERIAL PRIMARY KEY,
    rencana_id INTEGER REFERENCES rencana_produksi(id),
    code128_lot_number TEXT NOT NULL,
    print_type VARCHAR(50),
    printed_at TIMESTAMP DEFAULT NOW(),
    printer_name VARCHAR(100) DEFAULT 'Zebra ZD220',
    status VARCHAR(20) DEFAULT 'success'
);

-- Users Table
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);

-- Triggers
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

DROP TRIGGER IF EXISTS update_master_product_updated_at ON master_product;
CREATE TRIGGER update_master_product_updated_at 
    BEFORE UPDATE ON master_product 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_rencana_produksi_updated_at ON rencana_produksi;
CREATE TRIGGER update_rencana_produksi_updated_at 
    BEFORE UPDATE ON rencana_produksi 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();

-- Insert default admin (password: admin123)
INSERT INTO users (username, password_hash, full_name, role) 
VALUES ('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYzpLhRcQRi', 'Administrator', 'admin')
ON CONFLICT (username) DO NOTHING;

-- Seed master products
INSERT INTO master_product (nama_product, ukuran_roll, jumlah_roll_terproduksi) VALUES
('LID BENTO LOLIPOP', '022 X 660 MM', 0),
('Cup PP Oval 16oz Polos 7gr (Free Market)', 'PP Natural 1.24 x 710', 0),
('Blister PP Max love burger', 'PP NATURAL 0,51 x 700', 0),
('Cup PP Datar 22 oz Polos 7gr', 'PP NATURAL 1,23 x 720', 0),
('Lid Bento Bintang 4 Sekat (POLOS)', 'PET NATURAL 0,22 X 650', 0)
ON CONFLICT (nama_product, ukuran_roll) DO NOTHING;
EOSQL

PGPASSWORD=$DB_PASSWORD psql -h localhost -U $DB_USER -d $DB_NAME -f /tmp/schema.sql >/dev/null 2>&1
rm /tmp/schema.sql
print_success "Database schema created"

print_info "Saving configuration..."
cat > $PROJECT_DIR/config/.env <<EOF
DB_HOST=localhost
DB_PORT=5432
DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASSWORD
API_PORT=$API_PORT
SERVER_IP=$SERVER_IP
MQTT_BROKER=localhost
MQTT_PORT=1883
SECRET_KEY=$(openssl rand -hex 32)
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440
EOF
chmod 600 $PROJECT_DIR/config/.env
print_success "Configuration saved"

echo ""
print_success "âœ“ PHASE 2 COMPLETED"
sleep 2

#############################################
# PHASE 3: BACKEND INSTALLATION
#############################################
print_step "PHASE 3: BACKEND INSTALLATION"

cd $PROJECT_DIR/backend

print_info "Creating Python virtual environment..."
python3 -m venv venv
source venv/bin/activate

print_info "Installing Python dependencies..."
cat > requirements.txt <<EOF
fastapi==0.109.0
uvicorn[standard]==0.27.0
psycopg2-binary==2.9.9
paho-mqtt==1.6.1
python-multipart==0.0.6
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-dotenv==1.0.0
pydantic==2.5.3
pydantic-settings==2.1.0
gspread==5.12.0
oauth2client==4.1.3
EOF

pip install -q --upgrade pip >/dev/null 2>&1
pip install -q -r requirements.txt >/dev/null 2>&1 &
spinner $!
print_success "Python dependencies installed"

print_info "Creating backend application files..."

# Continue di message berikutnya...
echo "Backend setup continued in next step..."

echo ""
print_success "âœ“ PHASE 3 IN PROGRESS"

# Calculate elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
echo ""
echo "Elapsed time: $((ELAPSED / 60)) minutes $((ELAPSED % 60)) seconds"
echo ""
